__d(function(g,r,i,a,m,_e,d){"use strict";Object.defineProperty(_e,'__esModule',{value:!0}),_e.extractBarcodeWithOpenAI=async function(t,s,o){try{if(n.logger.info('[OpenAI Parser] Tentative extraction code-barres avec OpenAI Vision...'),s&&'guest'!==s&&!1===o)return n.logger.warn('[OpenAI Parser] Email non v\xe9rifi\xe9, extraction bloqu\xe9e'),null;if(await p(),s&&'guest'!==s){if(!await(0,e.checkUserAPILimit)(s))return n.logger.warn('[OpenAI Parser] Limite quotidienne atteinte pour extraction code-barres'),null}const l="Tu es un expert en lecture de codes-barres. Analyse cette image et extrais UNIQUEMENT les chiffres du code-barres (EAN-13, EAN-8, UPC, etc.).\n\nINSTRUCTIONS CRITIQUES:\n1. Cherche une s\xe9rie de chiffres (g\xe9n\xe9ralement 8, 12, ou 13 chiffres)\n2. Les chiffres sont souvent sous des barres verticales noires et blanches\n3. Retourne UNIQUEMENT les chiffres, sans espaces ni tirets\n4. Si tu vois plusieurs s\xe9ries de chiffres, prends la plus longue (code-barres principal)\n5. Si aucun code-barres n'est visible, r\xe9ponds \"AUCUN\"\n\nEXEMPLES:\n- Si tu vois \"3 017620 422003\" \u2192 r\xe9ponds \"3017620422003\"\n- Si tu vois \"8712100...\" \u2192 r\xe9ponds \"8712100...\"\n- Si pas de code-barres \u2192 r\xe9ponds \"AUCUN\"\n\nR\xe9ponds UNIQUEMENT avec les chiffres ou \"AUCUN\", rien d'autre.";n.logger.info('[OpenAI Parser] Envoi de la requ\xeate \xe0 OpenAI Vision...');const u=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:"Bearer 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"},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'user',content:[{type:'text',text:l},{type:'image_url',image_url:{url:`data:image/jpeg;base64,${t}`,detail:'high'}}]}],max_tokens:100,temperature:0})});if(!u.ok){const e=await u.text();return n.logger.error('[OpenAI Parser] Erreur API OpenAI:',u.status,e),null}const c=await u.json(),I=c.choices[0]?.message?.content?.trim()||'';if(n.logger.info('[OpenAI Parser] R\xe9ponse OpenAI:',I),s&&'guest'!==s&&await(0,e.incrementAPICall)(s),'AUCUN'===I||''===I)return n.logger.warn('[OpenAI Parser] Aucun code-barres d\xe9tect\xe9 par OpenAI'),null;const A=I.replace(/[^0-9]/g,'');if(A.length<8||A.length>14)return n.logger.warn('[OpenAI Parser] Code-barres invalide (longueur incorrecte):',A.length),null;let O=A;return 14===O.length&&O.startsWith('0')&&(O=O.substring(1)),13===O.length&&O.startsWith('0')&&(O=O.substring(1)),n.logger.info('[OpenAI Parser] \u2705 Code-barres extrait avec succ\xe8s:',{original:A,normalized:O}),O}catch(e){return n.logger.error('[OpenAI Parser] Erreur extraction code-barres:',e?.message||String(e)),null}},_e.parseMealWithOpenAI=async function(o,l,u){if(!o||0===o.trim().length)return{items:[],error:'Description vide'};if(l&&'guest'!==l&&!1===u)return{items:[],error:'Veuillez v\xe9rifier votre adresse email avant d\'utiliser l\'analyse IA. Consultez vos emails pour le lien de v\xe9rification.'};if(await p(),l&&'guest'!==l){const n=await(0,e.checkUserAPILimit)(l);if(!n.allowed)return{items:[],error:n.reason||'Limite d\'appels API atteinte. R\xe9essayez plus tard.'}}try{n.logger.info('[OpenAI] Envoi de la requ\xeate pour:',o.substring(0,50)+'...');const u=await fetch(s,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${t}`},body:JSON.stringify({model:'gpt-4o',messages:[{role:'system',content:"Tu es un nutritionniste expert en estimation calorique. Analyse une description de repas et extrais les aliments avec leurs VALEURS NUTRITIONNELLES PR\xc9CISES.\n\nMISSION PRINCIPALE: Fournir des estimations caloriques PR\xc9CISES pour un journal alimentaire de perte de poids.\n\nEXTRACTION EXHAUSTIVE - R\xc8GLE CRITIQUE:\n- Tu DOIS extraire TOUS les aliments mentionn\xe9s dans la description, sans exception\n- M\xeame si la description est longue et contient beaucoup d'aliments, tu dois tous les lister\n- Les boissons (bi\xe8res, vins, cocktails, jus, sodas, etc.) sont aussi des aliments \xe0 extraire avec leurs calories exactes\n- Ne saute AUCUN aliment, m\xeame s'il est mentionn\xe9 de mani\xe8re implicite\n\nALIMENTS COMESTIBLES UNIQUEMENT:\n- Ignore les objets non comestibles (pneus, clous, vis, etc.)\n- Retourne UNIQUEMENT des aliments et boissons comestibles\n- Si la description ne contient que des objets non comestibles, retourne: {\"items\": []}\n\nBOISSONS ALCOOLIS\xc9ES - ESTIMATIONS PR\xc9CISES OBLIGATOIRES:\nTu DOIS conna\xeetre les calories exactes des boissons populaires:\n- Bi\xe8re standard (341ml/12oz): ~150 kcal\n- Bi\xe8re l\xe9g\xe8re (341ml): ~100 kcal\n- Bi\xe8re forte/IPA (341ml): ~200 kcal\n- Bi\xe8re grande (500ml): ~220 kcal\n- Vin rouge/blanc (150ml): ~125 kcal\n- Vin ros\xe9 (150ml): ~120 kcal\n- Vodka/Gin/Rhum (45ml shot): ~100 kcal\n- Whisky/Cognac (45ml): ~105 kcal\n- Cocktail moyen: ~200-300 kcal\n- Margarita: ~280 kcal\n- Pi\xf1a Colada: ~490 kcal\n- Mojito: ~220 kcal\n- Sangria (200ml): ~150 kcal\n\nMARQUES DE BI\xc8RES CONNUES:\n- Budweiser (341ml): 145 kcal\n- Heineken (341ml): 150 kcal\n- Corona (341ml): 148 kcal\n- Molson Canadian (341ml): 145 kcal\n- Labatt Blue (341ml): 140 kcal\n- Stella Artois (341ml): 154 kcal\n- Guinness (500ml): 210 kcal\n- Coors Light (341ml): 102 kcal\n- Bud Light (341ml): 110 kcal\n\nCAT\xc9GORIES D'ALIMENTS:\n1. PROTEINE_MAIGRE: Viandes maigres, poissons, oeufs, tofu, yaourt grec\n2. LEGUME: Tous l\xe9gumes et fruits\n3. FECULENT_SIMPLE: Riz, p\xe2tes, pain, patates, c\xe9r\xe9ales\n4. ULTRA_TRANSFORME: Fast-food, plats pr\xe9par\xe9s, snacks industriels\n5. GRAS_FRIT: Fritures, aliments pan\xe9s/frits\n6. SUCRE: Desserts, bonbons, boissons sucr\xe9es\n7. ALCOOL: Bi\xe8res, vins, spiritueux, cocktails\n\nRetourne UNIQUEMENT un JSON valide avec cette structure:\n{\n  \"items\": [\n    {\n      \"name\": \"nom de l'aliment (nom EXACT mentionn\xe9 par l'utilisateur)\",\n      \"quantity\": \"quantit\xe9 avec unit\xe9 (ex: '200g', '1 tasse', '341ml', '2 bouteilles')\",\n      \"quantityNumber\": nombre,\n      \"category\": \"PROTEINE_MAIGRE | LEGUME | FECULENT_SIMPLE | ULTRA_TRANSFORME | GRAS_FRIT | SUCRE | ALCOOL\",\n      \"calories_kcal\": nombre (CALORIES PR\xc9CISES pour la quantit\xe9 indiqu\xe9e),\n      \"protein_g\": nombre,\n      \"carbs_g\": nombre,\n      \"fat_g\": nombre,\n      \"isComposite\": boolean\n    }\n  ]\n}\n\nR\xc8GLES CRITIQUES:\n- Le nom doit \xeatre EXACTEMENT ce que l'utilisateur a dit (pas de modifications)\n- calories_kcal doit \xeatre pour LA QUANTIT\xc9 TOTALE, pas pour 100g\n- Si l'utilisateur dit \"3 bi\xe8res\", calcule 3 x calories d'une bi\xe8re\n- Si l'utilisateur dit \"un verre de vin\", utilise une portion standard (150ml \u2248 125 kcal)\n- Pour les quantit\xe9s non sp\xe9cifi\xe9es, utilise des portions standards r\xe9alistes\n\nPORTIONS STANDARDS:\n- Viande/poisson: 150g\n- L\xe9gumes: 150g\n- Riz/p\xe2tes (cuit): 150g\n- Pain: 1 tranche = 30g\n- Bi\xe8re standard: 341ml\n- Vin: 150ml\n- Spiritueux: 45ml\n\nEXEMPLES:\n- \"3 bi\xe8res\" \u2192 calories_kcal: 450 (3 \xd7 150)\n- \"verre de vin rouge\" \u2192 calories_kcal: 125\n- \"2 shots de vodka\" \u2192 calories_kcal: 200 (2 \xd7 100)\n- \"poulet et riz\" \u2192 2 items: poulet (250 kcal) + riz (195 kcal)"},{role:'user',content:o}],temperature:.2,max_tokens:3e3})});if(l&&'guest'!==l&&await(0,e.incrementAPICall)(l).catch(e=>{n.logger.warn('[OpenAI] Erreur incr\xe9ment compteur:',e)}),!u.ok){const e=await u.json().catch(()=>({}));n.logger.error('[OpenAI] Erreur API:',{status:u.status,statusText:u.statusText,error:e});let t=`Erreur API OpenAI: ${u.status} ${u.statusText}`;if(401===u.status)t='Erreur d\'authentification: Cl\xe9 API OpenAI invalide ou expir\xe9e.';else if(429===u.status){const e=u.headers.get('Retry-After');if(e){const n=1e3*parseInt(e);t=`Limite de taux d\xe9pass\xe9e. R\xe9essayez dans ${Math.ceil(n/1e3)} seconde(s).`}else t='Limite de taux d\xe9pass\xe9e: Trop de requ\xeates \xe0 l\'API OpenAI. R\xe9essayez dans quelques instants.'}else u.status>=500?t='Erreur serveur OpenAI: Le service est temporairement indisponible.':e?.error?.message&&(t=`Erreur OpenAI: ${e.error.message}`);return{items:[],error:t}}const c=await u.json(),p=c.choices?.[0]?.message?.content;if(!p)return n.logger.error('[OpenAI] R\xe9ponse invalide: pas de contenu dans choices[0].message'),{items:[],error:'R\xe9ponse OpenAI invalide: aucun contenu retourn\xe9'};const I=p.match(/\{[\s\S]*\}/);if(!I)return n.logger.error('[OpenAI] Format invalide: aucun JSON trouv\xe9 dans la r\xe9ponse'),n.logger.error('[OpenAI] Contenu re\xe7u:',p.substring(0,200)),{items:[],error:'Format de r\xe9ponse OpenAI invalide: aucun JSON d\xe9tect\xe9'};let A;try{A=JSON.parse(I[0])}catch(e){return n.logger.error('[OpenAI] Erreur parsing JSON:',e),n.logger.error('[OpenAI] JSON extrait:',I[0].substring(0,200)),{items:[],error:`Erreur parsing JSON OpenAI: ${e.message}`}}if(!A.items||!Array.isArray(A.items))return n.logger.error('[OpenAI] Format JSON invalide: items manquant ou n\'est pas un tableau'),n.logger.error('[OpenAI] Objet pars\xe9:',A),{items:[],error:'Format JSON OpenAI invalide: items manquant ou invalide'};return{items:A.items.map(e=>({name:e.name||'',quantity:e.quantity||'1 portion',quantityNumber:e.quantityNumber||1,confidence:.9,category:e.category||void 0,calories_kcal:'number'==typeof e.calories_kcal?e.calories_kcal:void 0,protein_g:'number'==typeof e.protein_g?e.protein_g:void 0,carbs_g:'number'==typeof e.carbs_g?e.carbs_g:void 0,fat_g:'number'==typeof e.fat_g?e.fat_g:void 0,isComposite:'boolean'==typeof e.isComposite?e.isComposite:void 0})),rawResponse:p}}catch(e){return e instanceof TypeError&&e.message.includes('fetch')?(n.logger.error('[OpenAI] Erreur r\xe9seau:',e),{items:[],error:'Erreur r\xe9seau: Impossible de contacter l\'API OpenAI. V\xe9rifiez votre connexion internet.'}):(n.logger.error('[OpenAI] Erreur inattendue:',e),{items:[],error:`Erreur lors de l'appel OpenAI: ${e.message||'Erreur inconnue'}`})}},_e.parseMealPhotoWithOpenAI=async function(o,l,u){if(!o||0===o.trim().length)return{items:[],error:'Photo vide'};if(l&&'guest'!==l&&!1===u)return{items:[],error:'Veuillez v\xe9rifier votre adresse email avant d\'utiliser l\'analyse IA. Consultez vos emails pour le lien de v\xe9rification.'};if(await p(),l&&'guest'!==l){const n=await(0,e.checkUserAPILimit)(l);if(!n.allowed)return{items:[],error:n.reason||'Limite d\'appels API atteinte. R\xe9essayez plus tard.'}}try{n.logger.info('[OpenAI] Envoi requ\xeate photo (vision)');const u=await fetch(s,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${t}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'system',content:"Tu es un expert en nutrition. Analyse une PHOTO de repas et extrais tous les aliments visibles/identifiables avec leurs quantit\xe9s estim\xe9es.\n\nRetourne UNIQUEMENT un JSON valide avec cette structure:\n{\n  \"items\": [\n    {\n      \"name\": \"nom de l'aliment en fran\xe7ais\",\n      \"quantity\": \"quantit\xe9 avec unit\xe9 (ex: '200g', '1 portion', '2 oeufs')\",\n      \"quantityNumber\": nombre,\n      \"category\": \"PROTEINE_MAIGRE | LEGUME | FECULENT_SIMPLE | ULTRA_TRANSFORME | GRAS_FRIT | SUCRE\",\n      \"calories_kcal\": nombre,\n      \"protein_g\": nombre,\n      \"carbs_g\": nombre,\n      \"fat_g\": nombre,\n      \"isComposite\": boolean\n    }\n  ]\n}\n\nR\xc8GLES:\n- JSON seulement (pas de texte, pas de markdown)\n- Sois conservateur si l'image est floue: pr\xe9f\xe8re moins d'items plut\xf4t que d'inventer\n- Si la quantit\xe9 est inconnue: utilise \"1 portion\" et quantityNumber=1\n- Toujours fournir calories/prot\xe9ines/glucides/lipides (estimations r\xe9alistes)\n"},{role:'user',content:[{type:'text',text:'Analyse cette photo de repas et retourne le JSON demand\xe9.'},{type:'image_url',image_url:{url:`data:image/jpeg;base64,${o}`}}]}],temperature:.2})});if(l&&'guest'!==l)try{await(0,e.incrementAPICall)(l)}catch(e){n.logger.warn('[OpenAI] Impossible d\'incr\xe9menter le compteur API:',e)}if(!u.ok){let e=null;try{e=await u.json()}catch{}let n=`Erreur OpenAI (photo): ${u.status}`;if(401===u.status)n='Erreur d\'authentification: Cl\xe9 API OpenAI invalide ou expir\xe9e.';else if(429===u.status){const e=u.headers.get('Retry-After');if(e){const t=1e3*parseInt(e);n=`Limite de taux d\xe9pass\xe9e. R\xe9essayez dans ${Math.ceil(t/1e3)} seconde(s).`}else n='Limite de taux d\xe9pass\xe9e: Trop de requ\xeates \xe0 l\'API OpenAI. R\xe9essayez dans quelques instants.'}else u.status>=500?n='Erreur serveur OpenAI: Le service est temporairement indisponible.':e?.error?.message&&(n=`Erreur OpenAI: ${e.error.message}`);return{items:[],error:n}}const c=await u.json(),p=c.choices?.[0]?.message?.content;if(!p)return n.logger.error('[OpenAI] R\xe9ponse invalide (photo): pas de contenu'),{items:[],error:'R\xe9ponse OpenAI invalide: aucun contenu retourn\xe9'};const I=p.match(/\{[\s\S]*\}/);if(!I)return n.logger.error('[OpenAI] Format invalide (photo): aucun JSON trouv\xe9'),{items:[],error:'Format de r\xe9ponse OpenAI invalide: aucun JSON d\xe9tect\xe9'};let A;try{A=JSON.parse(I[0])}catch(e){return n.logger.error('[OpenAI] Erreur parsing JSON (photo):',e),{items:[],error:`Erreur parsing JSON OpenAI: ${e.message}`}}if(!A.items||!Array.isArray(A.items))return n.logger.error('[OpenAI] Format JSON invalide (photo): items manquant'),{items:[],error:'Format JSON OpenAI invalide: items manquant ou invalide'};return{items:A.items.map(e=>({name:e.name||'',quantity:e.quantity||'1 portion',quantityNumber:e.quantityNumber||1,confidence:.9,category:e.category||void 0,calories_kcal:'number'==typeof e.calories_kcal?e.calories_kcal:void 0,protein_g:'number'==typeof e.protein_g?e.protein_g:void 0,carbs_g:'number'==typeof e.carbs_g?e.carbs_g:void 0,fat_g:'number'==typeof e.fat_g?e.fat_g:void 0,isComposite:'boolean'==typeof e.isComposite?e.isComposite:void 0})),rawResponse:p}}catch(e){return e instanceof TypeError&&e.message.includes('fetch')?(n.logger.error('[OpenAI] Erreur r\xe9seau (photo):',e),{items:[],error:'Erreur r\xe9seau: Impossible de contacter l\'API OpenAI. V\xe9rifiez votre connexion internet.'}):(n.logger.error('[OpenAI] Erreur inattendue (photo):',e),{items:[],error:`Erreur lors de l'appel OpenAI (photo): ${e.message||'Erreur inconnue'}`})}};var e=r(d[0]),n=r(d[1]);const t="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",s='https://api.openai.com/v1/chat/completions',o=10;let l=0,u=Date.now(),c=0;async function p(){const e=Date.now(),t=e-u;if(t>6e4&&(l=0,u=e),l>=o){const e=6e4-t;n.logger.warn(`[OpenAI] Limite c\xf4t\xe9 client atteinte. Attente de ${Math.ceil(e/1e3)}s.`),await new Promise(n=>setTimeout(n,e+1e3)),l=0,u=Date.now()}const s=e-c;if(c>0&&s<2e3){const e=2e3-s;n.logger.warn(`[OpenAI] D\xe9lai minimum entre appels: ${Math.ceil(e/1e3)}s`),await new Promise(n=>setTimeout(n,e))}l++,c=Date.now()}},1320,[1321,1297]);
__d(function(g,r,i,a,m,e,d){"use strict";Object.defineProperty(e,'__esModule',{value:!0}),e.checkUserAPILimit=async function(l){if(!s.db||!l||'guest'===l)return{allowed:!1,reason:'Utilisateur non authentifi\xe9'};try{await c(l);const o=(0,t.doc)(s.db,'api_usage',l),u=await(0,t.getDoc)(o);if(!u.exists())return{allowed:!0};const y=u.data();if(y.callsToday>=y.dailyLimit)return{allowed:!1,reason:`Limite quotidienne atteinte (${y.dailyLimit} appels/jour). R\xe9essayez demain.`};if(y.lastCallTimestamp){const t=y.lastCallTimestamp.toMillis(),s=Date.now()-t;if(s<n){const t=n-s;return{allowed:!1,reason:`Veuillez patienter ${Math.ceil(t/1e3)} seconde(s) avant de r\xe9essayer.`}}}return{allowed:!0}}catch(t){return console.error('[API Rate Limit] Erreur v\xe9rification limite:',t),{allowed:!0}}},e.incrementAPICall=async function(n){if(!s.db||!n||'guest'===n)return;try{await c(n);const u=(0,t.doc)(s.db,'api_usage',n),y=await(0,t.getDoc)(u),p=o();if(y.exists()){const s=y.data();await(0,t.setDoc)(u,{...s,callsToday:s.callsToday+1,lastCallTimestamp:t.Timestamp.now()},{merge:!0})}else await(0,t.setDoc)(u,{userId:n,callsToday:1,dailyLimit:l,lastCallTimestamp:t.Timestamp.now(),lastResetDate:p})}catch(t){console.error('[API Rate Limit] Erreur incr\xe9ment appel:',t)}},e.getAPIUsageStats=async function(n){if(!s.db||!n||'guest'===n)return null;try{await c(n);const u=(0,t.doc)(s.db,'api_usage',n),y=await(0,t.getDoc)(u);return y.exists()?y.data():{userId:n,callsToday:0,dailyLimit:l,lastCallTimestamp:null,lastResetDate:o()}}catch(t){return console.error('[API Rate Limit] Erreur r\xe9cup\xe9ration stats:',t),null}};var t=r(d[0]),s=r(d[1]);const l=50,n=2e3;function o(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`}async function c(n){if(s.db)try{const c=(0,t.doc)((0,s.getDb)(),'api_usage',n),u=await(0,t.getDoc)(c),y=o();if(!u.exists())return void await(0,t.setDoc)(c,{userId:n,callsToday:0,dailyLimit:l,lastCallTimestamp:null,lastResetDate:y});const p=u.data();p.lastResetDate!==y&&await(0,t.setDoc)(c,{...p,callsToday:0,lastResetDate:y,lastCallTimestamp:null},{merge:!0})}catch(t){console.error('[API Rate Limit] Erreur reset limite:',t)}}},1321,[1446,857]);