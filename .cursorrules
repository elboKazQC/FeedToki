# FeedToki - RÃ¨gles de DÃ©veloppement Cursor

## ğŸ“‹ Vue d'ensemble
Application React Native (Expo SDK 54) de suivi nutritionnel gamifiÃ© avec systÃ¨me de points, Firebase, et IA (OpenAI).

## ğŸ¯ Principes GÃ©nÃ©raux

### Langue
- **UI/UX**: Toujours en franÃ§ais (messages utilisateur, labels, alertes)
- **Code**: Commentaires en franÃ§ais
- **Variables/Fonctions**: camelCase en anglais (convention React Native)

### Architecture
- **Frontend**: React Native avec Expo Router (file-based routing)
- **State**: React hooks (useState, useEffect, useMemo, useCallback) + AsyncStorage + Firestore
- **Auth**: Firebase Authentication (email/password)
- **Database**: Firestore (avec synchronisation bidirectionnelle AsyncStorage â†” Firestore)
- **AI**: OpenAI GPT-4o-mini pour parsing de repas

## ğŸ”§ Conventions de Code

### Naming
- **Variables/Fonctions**: `camelCase` (ex: `handleDeleteEntry`, `currentUserId`)
- **Composants**: `PascalCase` (ex: `HomeScreen`, `DragonDisplay`)
- **Fichiers**: `kebab-case.tsx` ou `camelCase.tsx` (ex: `best-days.tsx`, `data-sync.ts`)
- **Types/Interfaces**: `PascalCase` (ex: `MealEntry`, `UserProfile`)
- **Constantes**: `UPPER_SNAKE_CASE` (ex: `MAX_POINTS`, `DAILY_POINTS`)

### React Hooks - RÃˆGLE CRITIQUE
âš ï¸ **TOUJOURS dÃ©clarer TOUS les hooks AVANT tout `return` conditionnel**
```typescript
// âœ… CORRECT
export default function Component() {
  const [state, setState] = useState(false);
  const memoized = useMemo(() => ..., []);
  useEffect(() => {}, []);
  
  if (!isClient) return <Loading />; // AprÃ¨s tous les hooks
  
  return <MainContent />;
}

// âŒ INCORRECT - Erreur React #418/#310
export default function Component() {
  if (!isClient) return <Loading />; // AVANT les hooks !
  const [state, setState] = useState(false);
  return <MainContent />;
}
```

### Gestion d'Ã‰tat
- **Local state**: `useState` pour donnÃ©es temporaires/composant
- **AsyncStorage**: Pour donnÃ©es persistantes locales (backup/cache)
- **Firestore**: Source de vÃ©ritÃ© pour donnÃ©es cloud (multi-appareils)
- **Synchronisation**: Toujours via `lib/data-sync.ts` (fusion intelligente)

### Logging
- Utiliser `lib/logger.ts` pour logs structurÃ©s
- En production: `logger.debug()` et `logger.info()` sont mutÃ©s
- Toujours utiliser `logger.warn()` et `logger.error()` pour problÃ¨mes importants
- Pour logs temporaires: `console.log` avec `if (__DEV__)`

## ğŸ” SÃ©curitÃ© & Firebase

### Authentification
- VÃ©rification email requise pour utilisation IA (sauf admins)
- Admins: Liste centralisÃ©e dans `lib/admin-utils.ts`
- Guest mode: Permis mais fonctionnalitÃ©s limitÃ©es

### Firestore Security Rules
- Toujours vÃ©rifier `request.auth.uid` pour isolation des donnÃ©es
- Users peuvent lire/Ã©crire uniquement leurs propres donnÃ©es
- Admins: AccÃ¨s spÃ©cial via `isAdmin()` helper

### Rate Limiting
- OpenAI API: 50 appels/jour par utilisateur (Firestore-based)
- Client-side: 10 req/min avec dÃ©lai minimum 2s entre appels

## ğŸ“Š Synchronisation de DonnÃ©es

### Principe de Fusion
- **Points**: Prendre la valeur la plus HAUTE (pour prÃ©server remboursements/corrections)
- **Meals**: Fusion par ID (Firestore prioritaire si conflit)
- **Targets/Weights**: Firestore prioritaire si local vide

### Fonctions de Sync
- `syncFromFirestore()`: Charger depuis Firestore et fusionner avec local
- `syncToFirestore()`: Envoyer vers Firestore
- Toujours appeler aprÃ¨s modifications critiques (ajout/suppression repas, points)

### Points - RÃ¨gles SpÃ©ciales
- **Remboursement**: Lors de suppression d'entrÃ©e, restaurer points ET synchroniser Firestore
- **Fusion**: `Math.max(local, firestore)` pour Ã©viter perte de remboursements
- **Ã‰criture**: Ne jamais Ã©craser une valeur Firestore plus haute

## ğŸ¨ UI/UX

### ThÃ¨me
- Support dark/light mode via `lib/theme-context.tsx`
- Utiliser `useTheme()` hook pour accÃ©der aux couleurs
- Tokens de design dans `constants/design-tokens.ts`

### Composants
- Utiliser composants UI rÃ©utilisables: `Button`, `Card`, `ProgressBar`, `Badge`
- Modals: Utiliser React Native `Modal` (pas de View absolute) pour centrage correct

### Messages Utilisateur
- Toujours en franÃ§ais
- Messages d'erreur clairs et actionnables
- Pour emails Firebase (spam): Mentionner explicitement dossier SPAM/COURRIER INDÃ‰SIRABLE

## ğŸ› Patterns de Debugging

### Erreurs Hydratation React (#418/#310)
- Cause: Rendu conditionnel avant hooks OU mismatch SSR/client
- Solution: Ã‰tat `isClient` avec `useState(false)` + `useEffect(() => setIsClient(true), [])`
- Retourner "Chargement..." si `!isClient`, aprÃ¨s TOUS les hooks

### Data Isolation
- Toujours utiliser `currentUserId` correctement:
  ```typescript
  const currentUserId = profile?.userId || (user as any)?.uid || (user as any)?.id || 'guest';
  ```
- Reset state local lors changement d'utilisateur (useEffect avec dÃ©pendance `currentUserId`)

### RÃ©paration Automatique des Items Manquants
- **Fonction**: `repairMissingItemsInMeals()` dans `lib/sync-repair.ts`
- **RÃ´le**: DÃ©tecte les aliments mentionnÃ©s dans le titre d'un repas mais absents de l'array `items` et les ajoute automatiquement
- **ExÃ©cution**: Automatique au chargement des repas dans `app/(tabs)/index.tsx`
- **Logs**: Toujours afficher les logs de diagnostic (pas de `__DEV__`) pour tracer l'exÃ©cution
- **Exemple**: Si un repas a le titre "PÃ¢tes, Poulet, Brocoli, sauce blanche" mais que "sauce blanche" n'est pas dans `items`, la fonction l'ajoute automatiquement avec un score de similaritÃ© â‰¥ 0.5

### Console Logs
- En production: Utiliser `logger.debug()` / `logger.info()` (mutÃ©s)
- Logs critiques: Toujours `logger.warn()` / `logger.error()`
- Logs temporaires: `if (__DEV__) console.log(...)`

### âš ï¸ Logs de Diagnostic - RÃˆGLE CRITIQUE
**NE JAMAIS conditionner les logs de diagnostic par `__DEV__` si ils sont nÃ©cessaires pour le debugging en production**

```typescript
// âŒ INCORRECT - Logs invisibles en production
if (__DEV__) {
  console.log('[Sync Repair] ğŸ”§ RÃ©paration des items manquants...');
}

// âœ… CORRECT - Logs toujours visibles pour diagnostic
console.log('[Sync Repair] ğŸ”§ RÃ©paration des items manquants...');
```

**Raison**: Les logs de diagnostic sont essentiels pour comprendre pourquoi une fonction ne s'exÃ©cute pas ou Ã©choue silencieusement. Si un log est important pour le debugging (mÃªme en production), il doit Ãªtre toujours affichÃ©, pas seulement en dÃ©veloppement.

**Exception**: Seuls les logs de dÃ©veloppement temporaires (ex: valeurs de variables pour tests) peuvent Ãªtre conditionnÃ©s par `__DEV__`.

## ğŸ“ Structure de Fichiers

```
toki-app/
â”œâ”€â”€ app/                    # Expo Router pages
â”‚   â”œâ”€â”€ (tabs)/            # Pages principales (navigation tabs)
â”‚   â”œâ”€â”€ auth.tsx           # Login/signup
â”‚   â””â”€â”€ stats.tsx          # Statistiques
â”œâ”€â”€ lib/                   # Logique mÃ©tier
â”‚   â”œâ”€â”€ auth-context.tsx   # Context d'authentification
â”‚   â”œâ”€â”€ data-sync.ts       # Sync AsyncStorage â†” Firestore
â”‚   â”œâ”€â”€ firebase-*.ts      # Configuration Firebase
â”‚   â”œâ”€â”€ stats.ts           # Calculs de streaks/scores
â”‚   â”œâ”€â”€ points-*.ts        # SystÃ¨me de points
â”‚   â””â”€â”€ logger.ts          # Logging centralisÃ©
â”œâ”€â”€ components/            # Composants rÃ©utilisables
â”‚   â”œâ”€â”€ ui/               # Composants UI de base
â”‚   â””â”€â”€ *.tsx             # Composants spÃ©cifiques
â”œâ”€â”€ constants/            # Constantes et configuration
â””â”€â”€ scripts/              # Scripts utilitaires
```

## ğŸš€ DÃ©ploiement

### âš ï¸ MISE Ã€ JOUR DE VERSION - RÃˆGLE CRITIQUE

**TOUJOURS mettre Ã  jour la version AVANT de dÃ©ployer :**

1. **Mettre Ã  jour la version dans 3 fichiers :**
   - `toki-app/package.json` : `"version": "1.0.XX"`
   - `toki-app/app.json` : `"version": "1.0.XX"`
   - `toki-app/lib/build-version.ts` : `BUILD_VERSION = '1.0.XX'` ET `BUILD_DATE = 'YYYY-MM-DDTHH:mm:ss.000Z'` (date/heure actuelle)

2. **Incrementer le numÃ©ro de version** (ex: 1.0.20 â†’ 1.0.21)

3. **Mettre Ã  jour BUILD_DATE** avec la date/heure actuelle en UTC pour forcer le cache busting

4. **Puis build et dÃ©ployer :**
   ```bash
   cd toki-app
   npx expo export --platform web --clear --output-dir web-build
   npx ts-node scripts/verify-build-version.ts web-build
   firebase deploy --only hosting
   ```
   
   **OU utiliser le script automatique :**
   ```bash
   cd toki-app
   scripts\build-production.bat
   ```

**Pourquoi ?** Le cache busting utilise BUILD_VERSION et BUILD_DATE. Si la version n'est pas mise Ã  jour, les utilisateurs verront l'ancienne version en cache.

### âœ… VÃ‰RIFICATION AVANT DÃ‰PLOIEMENT - RÃˆGLE CRITIQUE

**TOUJOURS vÃ©rifier avant de dÃ©ployer :**

1. **Checklist de vÃ©rification :**
   - [ ] Version mise Ã  jour dans `package.json`, `app.json`, `build-version.ts`
   - [ ] `BUILD_DATE` mis Ã  jour avec date/heure actuelle en UTC
   - [ ] Build exÃ©cutÃ© avec `--clear` pour vider le cache Metro Bundler
   - [ ] VÃ©rification que le bundle contient la bonne version (script `verify-build-version.ts`)
   - [ ] Hash du bundle a changÃ© (indique un nouveau build)

2. **Utiliser le script de vÃ©rification :**
   ```bash
   cd toki-app
   npx ts-node scripts/verify-build-version.ts web-build
   ```
   
   Le script doit afficher `âœ… SUCCÃˆS: Les versions correspondent!` avant de dÃ©ployer.

3. **Si la vÃ©rification Ã©choue :**
   - VÃ©rifier que `build-version.ts` contient la bonne version
   - Rebuild avec `--clear` pour vider le cache Metro
   - Utiliser le script `build-production.bat` qui rÃ©gÃ©nÃ¨re automatiquement `build-version.ts`

4. **Importance de `--clear` :**
   - Le cache Metro Bundler peut contenir d'anciennes versions de `build-version.ts`
   - Toujours utiliser `--clear` lors du build pour garantir un build propre
   - Le script `build-production.bat` inclut automatiquement `--clear`

### Build Production Web
```bash
cd toki-app
npx expo export --platform web --clear --output-dir web-build
npx ts-node scripts/verify-build-version.ts web-build
firebase deploy --only hosting
```

**OU utiliser le script automatique (recommandÃ©) :**
```bash
cd toki-app
scripts\build-production.bat
```

Le script `build-production.bat` :
- RÃ©gÃ©nÃ¨re automatiquement `build-version.ts` avec la version de `package.json`
- Vide le cache Metro avec `--clear`
- VÃ©rifie que le bundle contient la bonne version
- DÃ©ploie sur Firebase Hosting

### Variables d'Environnement
- `.env.production`: ClÃ©s API (NE JAMAIS commiter)
- Variables Expo: PrÃ©fixe `EXPO_PUBLIC_` pour exposition client

## âœ… Checklist Avant Commit

- [ ] Tous les hooks dÃ©clarÃ©s avant `return` conditionnel
- [ ] `currentUserId` utilisÃ© correctement pour isolation
- [ ] Sync Firestore appelÃ©e aprÃ¨s modifications critiques
- [ ] Messages utilisateur en franÃ§ais
- [ ] Logs de prod via `logger` (pas `console.log` direct)
- [ ] Pas de clÃ©s API/secrÃ¨tes dans le code
- [ ] Types TypeScript corrects (pas de `any` sauf Firebase user)
- [ ] Gestion d'erreurs avec try/catch pour opÃ©rations async

## ğŸ“ Bonnes Pratiques

### Performance
- Utiliser `useMemo` pour calculs coÃ»teux (streaks, stats)
- Utiliser `useCallback` pour callbacks passÃ©s en props (Ã©viter re-renders)
- Limiter re-renders: State local minimal, props stables

### MaintenabilitÃ©
- Commenter le "pourquoi", pas le "quoi" (code auto-documentÃ©)
- Exporter types depuis `lib/types.ts` (pas inline)
- Fonctions pures quand possible (facilitent tests)
- Helpers rÃ©utilisables dans `lib/`

### Tests
- Tests unitaires pour logique mÃ©tier (`lib/stats.ts`, `lib/points-*.ts`)
- Tests d'intÃ©gration pour flows critiques (login, sync)
- Mocker Firebase/AsyncStorage dans tests

## ğŸ”„ Migration & Backward Compatibility

### Versioning
- AsyncStorage keys: Inclure version (ex: `feedtoki_entries_${userId}_v1`)
- Changements breaking: Nouvelle version de key + migration script
- Firestore: Structure documentÃ©e, migrations via scripts

### Error Handling
- OpÃ©rations async: Toujours try/catch
- Sync Firestore: Ne pas bloquer UI si Ã©chec (logger warning, continuer local)
- Messages d'erreur: Actionnables pour utilisateur (pas de stack traces)

## ğŸ“ Documentation

- README.md: Vue d'ensemble, setup, scripts
- GUIDE_DEPLOIEMENT.md: Instructions dÃ©ploiement
- CHANGELOG.md: Historique des changements
- POINTS_SYSTEM_EXPLANATION.md: Explication systÃ¨me de points

---

**DerniÃ¨re mise Ã  jour**: Janvier 2025
**Version app**: 1.0.21
