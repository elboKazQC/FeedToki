# FeedToki - RÃ¨gles de DÃ©veloppement Cursor

## ğŸ“‹ Vue d'ensemble
Application React Native (Expo SDK 54) de suivi nutritionnel gamifiÃ© avec systÃ¨me de points, Firebase, et IA (OpenAI).

## ğŸ¯ Principes GÃ©nÃ©raux

### Langue
- **UI/UX**: Toujours en franÃ§ais (messages utilisateur, labels, alertes)
- **Code**: Commentaires en franÃ§ais
- **Variables/Fonctions**: camelCase en anglais (convention React Native)

### Architecture
- **Frontend**: React Native avec Expo Router (file-based routing)
- **State**: React hooks (useState, useEffect, useMemo, useCallback) + AsyncStorage + Firestore
- **Auth**: Firebase Authentication (email/password)
- **Database**: Firestore (avec synchronisation bidirectionnelle AsyncStorage â†” Firestore)
- **AI**: OpenAI GPT-4o-mini pour parsing de repas

## ğŸ”§ Conventions de Code

### Naming
- **Variables/Fonctions**: `camelCase` (ex: `handleDeleteEntry`, `currentUserId`)
- **Composants**: `PascalCase` (ex: `HomeScreen`, `DragonDisplay`)
- **Fichiers**: `kebab-case.tsx` ou `camelCase.tsx` (ex: `best-days.tsx`, `data-sync.ts`)
- **Types/Interfaces**: `PascalCase` (ex: `MealEntry`, `UserProfile`)
- **Constantes**: `UPPER_SNAKE_CASE` (ex: `MAX_POINTS`, `DAILY_POINTS`)

### React Hooks - RÃˆGLE CRITIQUE
âš ï¸ **TOUJOURS dÃ©clarer TOUS les hooks AVANT tout `return` conditionnel**
```typescript
// âœ… CORRECT
export default function Component() {
  const [state, setState] = useState(false);
  const memoized = useMemo(() => ..., []);
  useEffect(() => {}, []);
  
  if (!isClient) return <Loading />; // AprÃ¨s tous les hooks
  
  return <MainContent />;
}

// âŒ INCORRECT - Erreur React #418/#310
export default function Component() {
  if (!isClient) return <Loading />; // AVANT les hooks !
  const [state, setState] = useState(false);
  return <MainContent />;
}
```

### Gestion d'Ã‰tat
- **Local state**: `useState` pour donnÃ©es temporaires/composant
- **AsyncStorage**: Pour donnÃ©es persistantes locales (backup/cache)
- **Firestore**: Source de vÃ©ritÃ© pour donnÃ©es cloud (multi-appareils)
- **Synchronisation**: Toujours via `lib/data-sync.ts` (fusion intelligente)

### Logging
- Utiliser `lib/logger.ts` pour logs structurÃ©s
- En production: `logger.debug()` et `logger.info()` sont mutÃ©s
- Toujours utiliser `logger.warn()` et `logger.error()` pour problÃ¨mes importants
- Pour logs temporaires: `console.log` avec `if (__DEV__)`

## ğŸ” SÃ©curitÃ© & Firebase

### Authentification
- VÃ©rification email requise pour utilisation IA (sauf admins)
- Admins: Liste centralisÃ©e dans `lib/admin-utils.ts`
- Guest mode: Permis mais fonctionnalitÃ©s limitÃ©es

### Firestore Security Rules
- Toujours vÃ©rifier `request.auth.uid` pour isolation des donnÃ©es
- Users peuvent lire/Ã©crire uniquement leurs propres donnÃ©es
- Admins: AccÃ¨s spÃ©cial via `isAdmin()` helper

### Rate Limiting
- OpenAI API: 50 appels/jour par utilisateur (Firestore-based)
- Client-side: 10 req/min avec dÃ©lai minimum 2s entre appels

## ğŸ“Š Synchronisation de DonnÃ©es

### Principe de Fusion
- **Points**: Prendre la valeur la plus HAUTE (pour prÃ©server remboursements/corrections)
- **Meals**: Fusion par ID (Firestore prioritaire si conflit)
- **Targets/Weights**: Firestore prioritaire si local vide

### Fonctions de Sync
- `syncFromFirestore()`: Charger depuis Firestore et fusionner avec local
- `syncToFirestore()`: Envoyer vers Firestore
- Toujours appeler aprÃ¨s modifications critiques (ajout/suppression repas, points)

### Points - RÃ¨gles SpÃ©ciales
- **Remboursement**: Lors de suppression d'entrÃ©e, restaurer points ET synchroniser Firestore
- **Fusion**: `Math.max(local, firestore)` pour Ã©viter perte de remboursements
- **Ã‰criture**: Ne jamais Ã©craser une valeur Firestore plus haute

## ğŸ¨ UI/UX

### ThÃ¨me
- Support dark/light mode via `lib/theme-context.tsx`
- Utiliser `useTheme()` hook pour accÃ©der aux couleurs
- Tokens de design dans `constants/design-tokens.ts`

### Composants
- Utiliser composants UI rÃ©utilisables: `Button`, `Card`, `ProgressBar`, `Badge`
- Modals: Utiliser React Native `Modal` (pas de View absolute) pour centrage correct

### Messages Utilisateur
- Toujours en franÃ§ais
- Messages d'erreur clairs et actionnables
- Pour emails Firebase (spam): Mentionner explicitement dossier SPAM/COURRIER INDÃ‰SIRABLE

## ğŸ› Patterns de Debugging

### Erreurs Hydratation React (#418/#310)
- Cause: Rendu conditionnel avant hooks OU mismatch SSR/client
- Solution: Ã‰tat `isClient` avec `useState(false)` + `useEffect(() => setIsClient(true), [])`
- Retourner "Chargement..." si `!isClient`, aprÃ¨s TOUS les hooks

### Data Isolation
- Toujours utiliser `currentUserId` correctement:
  ```typescript
  const currentUserId = profile?.userId || (user as any)?.uid || (user as any)?.id || 'guest';
  ```
- Reset state local lors changement d'utilisateur (useEffect avec dÃ©pendance `currentUserId`)

### Console Logs
- En production: Utiliser `logger.debug()` / `logger.info()` (mutÃ©s)
- Logs critiques: Toujours `logger.warn()` / `logger.error()`
- Logs temporaires: `if (__DEV__) console.log(...)`

## ğŸ“ Structure de Fichiers

```
toki-app/
â”œâ”€â”€ app/                    # Expo Router pages
â”‚   â”œâ”€â”€ (tabs)/            # Pages principales (navigation tabs)
â”‚   â”œâ”€â”€ auth.tsx           # Login/signup
â”‚   â””â”€â”€ stats.tsx          # Statistiques
â”œâ”€â”€ lib/                   # Logique mÃ©tier
â”‚   â”œâ”€â”€ auth-context.tsx   # Context d'authentification
â”‚   â”œâ”€â”€ data-sync.ts       # Sync AsyncStorage â†” Firestore
â”‚   â”œâ”€â”€ firebase-*.ts      # Configuration Firebase
â”‚   â”œâ”€â”€ stats.ts           # Calculs de streaks/scores
â”‚   â”œâ”€â”€ points-*.ts        # SystÃ¨me de points
â”‚   â””â”€â”€ logger.ts          # Logging centralisÃ©
â”œâ”€â”€ components/            # Composants rÃ©utilisables
â”‚   â”œâ”€â”€ ui/               # Composants UI de base
â”‚   â””â”€â”€ *.tsx             # Composants spÃ©cifiques
â”œâ”€â”€ constants/            # Constantes et configuration
â””â”€â”€ scripts/              # Scripts utilitaires
```

## ğŸš€ DÃ©ploiement

### Build Production Web
```bash
cd toki-app
npx expo export --platform web
cp -r dist/* web-build/
firebase deploy --only hosting
```

### Variables d'Environnement
- `.env.production`: ClÃ©s API (NE JAMAIS commiter)
- Variables Expo: PrÃ©fixe `EXPO_PUBLIC_` pour exposition client

## âœ… Checklist Avant Commit

- [ ] Tous les hooks dÃ©clarÃ©s avant `return` conditionnel
- [ ] `currentUserId` utilisÃ© correctement pour isolation
- [ ] Sync Firestore appelÃ©e aprÃ¨s modifications critiques
- [ ] Messages utilisateur en franÃ§ais
- [ ] Logs de prod via `logger` (pas `console.log` direct)
- [ ] Pas de clÃ©s API/secrÃ¨tes dans le code
- [ ] Types TypeScript corrects (pas de `any` sauf Firebase user)
- [ ] Gestion d'erreurs avec try/catch pour opÃ©rations async

## ğŸ“ Bonnes Pratiques

### Performance
- Utiliser `useMemo` pour calculs coÃ»teux (streaks, stats)
- Utiliser `useCallback` pour callbacks passÃ©s en props (Ã©viter re-renders)
- Limiter re-renders: State local minimal, props stables

### MaintenabilitÃ©
- Commenter le "pourquoi", pas le "quoi" (code auto-documentÃ©)
- Exporter types depuis `lib/types.ts` (pas inline)
- Fonctions pures quand possible (facilitent tests)
- Helpers rÃ©utilisables dans `lib/`

### Tests
- Tests unitaires pour logique mÃ©tier (`lib/stats.ts`, `lib/points-*.ts`)
- Tests d'intÃ©gration pour flows critiques (login, sync)
- Mocker Firebase/AsyncStorage dans tests

## ğŸ”„ Migration & Backward Compatibility

### Versioning
- AsyncStorage keys: Inclure version (ex: `feedtoki_entries_${userId}_v1`)
- Changements breaking: Nouvelle version de key + migration script
- Firestore: Structure documentÃ©e, migrations via scripts

### Error Handling
- OpÃ©rations async: Toujours try/catch
- Sync Firestore: Ne pas bloquer UI si Ã©chec (logger warning, continuer local)
- Messages d'erreur: Actionnables pour utilisateur (pas de stack traces)

## ğŸ“ Documentation

- README.md: Vue d'ensemble, setup, scripts
- GUIDE_DEPLOIEMENT.md: Instructions dÃ©ploiement
- CHANGELOG.md: Historique des changements
- POINTS_SYSTEM_EXPLANATION.md: Explication systÃ¨me de points

---

**DerniÃ¨re mise Ã  jour**: Janvier 2025
**Version app**: 1.0.0
